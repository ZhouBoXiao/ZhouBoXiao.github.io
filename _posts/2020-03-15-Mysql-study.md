---
layout:     post
title:      "MySQL相关知识"
subtitle:   "MySQL的原理、数据结构、引擎、使用、事务隔离级别等"
date:       2020-03-01
author:     "ZBX"
header-img: "img/tag-bg.jpg"
tags:
    - MySQL
---

~还待进一步完善~

# 索引

## B+ Tree 

1. 单次请求涉及的磁盘IO次数少（出度d大，且非叶子节点不包含表数据，树的高度小）；
2. 查询效率稳定（任何关键字的查询必须走从根结点到叶子结点，查询路径长度相同），且插入与修改拥有较稳定的对数时间复杂度；
3. 遍历效率高（从符合条件的某个叶子节点开始遍历即可）；叶子节点之间通过指针来连接，范围扫描将十分简单；

4. B+树的用途[1]
   1. ReiserFS、NSS、XFS、JFS、ReFS和BFS文件系统都使用这种类型的树来进行元数据索引；
   2. BFS还使用B+树来存储目录。NTFS使用B+树来建立目录和与安全相关的元数据索引。EXT4使用extent 树(一个修改过的B+树数据结构)来建立文件的区段索引；
   3. 关系数据库管理系统，如IBM DB2、Informix、Microsoft SQL Server、Oracle 8、Sybase ASE和SQLite[5]支持这种类型的树作为表索引。CouchDB和Tokyo Cabinet等键值数据库管理系统支持这种类型的树来进行数据访问。
5. B+树与B-树
   1. B+树的叶子节点是以链表的形式相互链接；这使得范围查询更简单、更有效。且不会显著增加树的空间消耗或维护成本。B+树的相对于B-树的一个重要优势;
   2. B+树元素自底向上插入

## Hash索引

哈希索引能以 O(1) 时间进行查找，但是失去了有序性：

- 无法用于排序与分组；
- 只支持精确查找，无法用于部分查找和范围查找。

## 前缀索引

对于 BLOB、TEXT 和 VARCHAR 类型的列，必须使用前缀索引，只索引开始的部分字符。

前缀长度的选取需要根据索引选择性来确定。

## 小问题

1. 什么是主键索引？

   主键索引是指唯一索引，创建表中的主键就会建立主键索引，也称聚簇索引。

2. 什么是联合索引？

   对表里的多列同时建立的索引，根据创建联合索引的顺序，以最左原则进行检索。

3. 什么是覆盖索引？

   根据辅助索引就可以直接查询到结果，而不需要回表到聚簇索引中进行再次查询，可以减少IO次数。

4. 什么是索引条件下推？

   MySQL 5.6引入了索引下推优化，可以在索引遍历过程中，对索引中包含的字段先做判断，过滤掉不符合条件的记录，减少回表字数。

## ACID

- **原子性**（Atomicity）
  - 事务是最小的执行单位，不允许分割。事务的原子性确保动作要么全部完成，要么完全不起作用；
- **一致性**（Consistency）
  - 执行事务前后，数据保持一致，多个事务对同一个数据读取的结果是相同的；
- **隔离性**（Isolation）
  - 并发访问数据库时，一个用户的事务不被其他事务所干扰，各并发事务之间数据库是独立的；
- **持久性**（Durability）
  - 一个事务被提交之后。它对数据库中数据的改变是持久的，即使数据库发生故障也不应该对其有任何影响。
  - `MySQL` 使用 `redo log` 来保证事务的持久性

# 并发一致性问题

- **脏读（Dirty read）:** 当一个事务正在访问数据并且对数据进行了修改，而这种修改还没有提交到数据库中，这时另外一个事务也访问了这个数据，然后使用了这个数据。因为这个数据是还没有提交的数据，那么另外一个事务读到的这个数据是“脏数据”，依据“脏数据”所做的操作可能是不正确的。
- **丢失修改（Lost to modify）:** 指在一个事务读取一个数据时，另外一个事务也访问了该数据，那么在第一个事务中修改了这个数据后，第二个事务也修改了这个数据。这样第一个事务内的修改结果就被丢失，因此称为丢失修改。 例如：事务1读取某表中的数据A=20，事务2也读取A=20，事务1修改A=A-1，事务2也修改A=A-1，最终结果A=19，事务1的修改被丢失。
- **不可重复读（Unrepeatableread）:** 指在一个事务内多次读同一数据。在这个事务还没有结束时，另一个事务也访问该数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改导致第一个事务两次读取的数据可能不太一样。这就发生了在一个事务内两次读到的数据是不一样的情况，因此称为不可重复读。
- **幻读（Phantom read）:** 幻读与不可重复读类似。它发生在一个事务（T1）读取了几行数据，接着另一个并发事务（T2）插入了一些数据时。在随后的查询中，第一个事务（T1）就会发现多了一些原本不存在的记录，就好像发生了幻觉一样，所以称为幻读。

## 四大隔离级别

**SQL 标准定义了四个隔离级别：**

- **READ-UNCOMMITTED(读取未提交)：** 最低的隔离级别，允许读取尚未提交的数据变更，**可能会导致脏读、幻读或不可重复读**。
- **READ-COMMITTED(读取已提交)：** 允许读取并发事务已经提交的数据，**可以阻止脏读，但是幻读或不可重复读仍有可能发生**。
- **REPEATABLE-READ(可重复读)：** 对同一字段的多次读取结果都是一致的，除非数据是被本身事务自己所修改，**可以阻止脏读和不可重复读，但幻读仍有可能发生**。
- **SERIALIZABLE(可串行化)：** 最高的隔离级别，完全服从ACID的隔离级别。所有的事务依次逐个执行，这样事务之间就完全不可能产生干扰，也就是说，**该级别可以防止脏读、不可重复读以及幻读**。

## 乐观锁与悲观锁



## 多版本并发控制MVCC



##  范式



3. 

## 索引以及优化



## 日志

- **undo log**
  - 回滚和多版本控制(`MVCC`)
  - 存储着修改之前的数据，如果有`update`，则存储对应的`delete`
- **binlog**
  - 复制和恢复数据
  - 主从服务器需要保持数据的一致性，通过`binlog`来同步数据
- **redo log**
  - `redo log`记录的是数据的**物理变化**，`binlog`记录的是数据的**逻辑变化**
  - 不会存储着**历史**所有数据的变更，**文件的内容会被覆盖的**。

## 主从复制原理、作用和实现





**参考：** 

[1] https://en.wikipedia.org/wiki/B%2B_tree